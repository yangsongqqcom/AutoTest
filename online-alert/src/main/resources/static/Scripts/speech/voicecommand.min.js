/* SmartAdmin - v1.4.1 - 2014-06-26 */
var root=this,SpeechRecognition=root.SpeechRecognition||root.webkitSpeechRecognition||root.mozSpeechRecognition||root.msSpeechRecognition||root.oSpeechRecognition;if(SpeechRecognition&&voice_command){$.root_.on("click",'[data-action="voiceCommand"]',function(b){if($.root_.hasClass("voice-command-active")){$.speechApp.stop()}else{$.speechApp.start(),$("#speech-btn .popover").fadeIn(350)}b.preventDefault()});$(document).mouseup(function(b){$("#speech-btn .popover").is(b.target)||0!==$("#speech-btn .popover").has(b.target).length||$("#speech-btn .popover").fadeOut(250)});var modal=$('<div class="modal fade" id="voiceModal" tabindex="-1" role="dialog" aria-labelledby="remoteModalLabel" aria-hidden="true"><div class="modal-dialog"><div class="modal-content"></div></div></div>');modal.appendTo("body"),$.speechApp=function(b){b.start=function(){smartSpeechRecognition.addCommands(commands);if(smartSpeechRecognition){smartSpeechRecognition.start(),$.root_.addClass("voice-command-active"),$.speechApp.playON(),voice_localStorage&&localStorage.setItem("sm-setautovoice","true")}else{alert("speech plugin not loaded")}};b.stop=function(){if(smartSpeechRecognition){smartSpeechRecognition.abort(),$.root_.removeClass("voice-command-active"),$.speechApp.playOFF(),voice_localStorage&&localStorage.setItem("sm-setautovoice","false"),$("#speech-btn .popover").is(":visible")&&$("#speech-btn .popover").fadeOut(250)}};b.playON=function(){var c=document.createElement("audio");navigator.userAgent.match("Firefox/")?c.setAttribute("src",$.sound_path+"voice_on.ogg"):c.setAttribute("src",$.sound_path+"voice_on.mp3"),c.addEventListener("load",function(){c.play()},!0),$.sound_on&&(c.pause(),c.play())};b.playOFF=function(){var c=document.createElement("audio");navigator.userAgent.match("Firefox/")?c.setAttribute("src",$.sound_path+"voice_off.ogg"):c.setAttribute("src",$.sound_path+"voice_off.mp3"),$.get(),c.addEventListener("load",function(){c.play()},!0),$.sound_on&&(c.pause(),c.play())};b.playConfirmation=function(){var c=document.createElement("audio");navigator.userAgent.match("Firefox/")?c.setAttribute("src",$.sound_path+"voice_alert.ogg"):c.setAttribute("src",$.sound_path+"voice_alert.mp3"),$.get(),c.addEventListener("load",function(){c.play()},!0),$.sound_on&&(c.pause(),c.play())};return b}({})}else{$("#speech-btn").addClass("display-none")}(function(r){if(!SpeechRecognition){root.smartSpeechRecognition=null;return r}var s,t,u=[];var v={start:[],error:[],end:[],result:[],resultMatch:[],resultNoMatch:[],errorNetwork:[],errorPermissionBlocked:[],errorPermissionDenied:[]};var w=0,x=!1,y="font-weight: bold; color: #00f;",z=/\s*\((.*?)\)\s*/g,A=/(\(\?:[^)]+\))\?/g,B=/(\(\?)?:\w+/g,C=/\*\w+/g,D=/[\-{}\[\]+?.,\\\^$|#]/g;var E=function(b){return b=b.replace(D,"\\$&").replace(z,"(?:$1)?").replace(B,function(c,d){return d?c:"([^\\s]+)"}).replace(C,"(.*?)").replace(A,"\\s*$1?\\s*"),new RegExp("^"+b+"$","i")};var F=function(b){b.forEach(function(c){c.callback.apply(c.context)})};var G=function(){H()||root.smartSpeechRecognition.init({},!1)};var H=function(){return s!==r};root.smartSpeechRecognition={init:function(a,b){b=b===r?!0:!!b,s&&s.abort&&s.abort(),s=new SpeechRecognition,s.maxAlternatives=5,s.continuous=!0,s.lang=voice_command_lang||"en-US",s.onstart=function(){F(v.start),$.root_.removeClass("service-not-allowed"),$.root_.addClass("service-allowed")},s.onerror=function(c){switch(F(v.error),c.error){case"network":F(v.errorNetwork);break;case"not-allowed":case"service-not-allowed":t=!1,$.root_.removeClass("service-allowed"),$.root_.addClass("service-not-allowed"),F((new Date).getTime()-w<200?v.errorPermissionBlocked:v.errorPermissionDenied)}},s.onend=function(){if(F(v.end),t){var c=(new Date).getTime()-w;1000>c?setTimeout(root.smartSpeechRecognition.start,1000-c):root.smartSpeechRecognition.start()}},s.onresult=function(d){F(v.result);for(var e,g=d.results[d.resultIndex],h=0;h<g.length;h++){e=g[h].transcript.trim(),x&&root.console.log("Speech recognized: %c"+e,y);for(var n=0,o=u.length;o>n;n++){var p=u[n].command.exec(e);if(p){var q=p.slice(1);x&&(root.console.log("command matched: %c"+u[n].originalPhrase,y),q.length&&root.console.log("with parameters",q)),u[n].callback.apply(this,q),F(v.resultMatch);var I=["sound on","mute","stop"];if(I.indexOf(u[n].originalPhrase)<0){$.smallBox({title:u[n].originalPhrase,content:"loading...",color:"#333",sound_file:"voice_alert",timeout:2000}),$("#speech-btn .popover").is(":visible")&&$("#speech-btn .popover").fadeOut(250)}return !0}}}F(v.resultNoMatch),$.smallBox({title:'Error: <strong> " '+e+' " </strong> no match found!',content:"Please speak clearly into the microphone",color:"#a90329",timeout:5000,icon:"fa fa-microphone"}),$("#speech-btn .popover").is(":visible")&&$("#speech-btn .popover").fadeOut(250);return !1},b&&(u=[]),a.length&&this.addCommands(a)},start:function(a){G(),a=a||{},t=a.autoRestart!==r?!!a.autoRestart:!0,w=(new Date).getTime(),s.start()},abort:function(){t=!1,H&&s.abort()},debug:function(b){x=arguments.length>0?!!b:!0},setLanguage:function(b){G(),s.lang=b},addCommands:function(d){var f,g;G();for(var h in d){if(d.hasOwnProperty(h)){if(f=root[d[h]]||d[h],"function"!=typeof f){continue}g=E(h),u.push({command:g,callback:f,originalPhrase:h})}}x&&root.console.log("Commands successfully loaded: %c"+u.length,y)},removeCommands:function(a){return a===r?void (u=[]):(a=Array.isArray(a)?a:[a],void (u=u.filter(function(b){for(var d=0;d<a.length;d++){if(a[d]===b.originalPhrase){return !1}}return !0})))},addCallback:function(a,e,g){if(v[a]!==r){var h=root[e]||e;"function"==typeof h&&v[a].push({callback:h,context:g||this})}}}}).call(this);var autoStart=function(){smartSpeechRecognition.addCommands(commands),smartSpeechRecognition?(smartSpeechRecognition.start(),$.root_.addClass("voice-command-active"),voice_localStorage&&localStorage.setItem("sm-setautovoice","true")):alert("主意插件未加载")};SpeechRecognition&&voice_command&&"true"==localStorage.getItem("sm-setautovoice")&&autoStart(),SpeechRecognition&&voice_command_auto&&voice_command&&autoStart();